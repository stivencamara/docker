import{q as Y,D as Z,h as x,i as v,s as ee,j as s,b as W,l as R,v as t,d as te,r as z,o as m,e as V,m as a,F as A,a as u,y as k,c as L,w as J,f as ae,x as oe,Q as ie,K as re,E as K,M as se,X as ne,z as de,O as le,Y as ce,t as ue}from"./index-d8a56bcc.js";import{b as pe}from"./refusal-a1b91175.js";import{b as Q}from"./helpers-d89764d1.js";import{p as me}from"./helpers-a03e04a5.js";import{o as ye}from"./helpers-1cb82c85.js";import{d as be}from"./helpers-71f72544.js";import{s as fe}from"./helpers-eb16543c.js";import{h as ge}from"./helpers-3cc5802d.js";import{s as Te}from"./settings-55cfd82c.js";const Se={__name:"record-state-actions",props:{loading:{Boolean,required:!0},canEdit:{Boolean,required:!0},recordStateTypeId:{required:!0},service:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},objectTypeId:{required:!0},name:{type:String},store:{type:Object,required:!0},itemVersionField:{type:String,required:!0},editRoute:{type:String,required:!0}},setup(p){const r=p,e=Y(),D=Z(),j=x();let y="record-state-type",b=v(null),f=v(0),C=v(!1),l=v(!1),g=ee({refusalTypeId:null,description:""}),E=v(s.createEmptyDataSource()),F=v(null);const $=()=>{l.value=!1},N=async()=>{switch(f.value){case t.recordStateType.archived:await I();break;case t.recordStateType.submitted:await o();break;case t.recordStateType.draft:await B();break;case t.recordStateType.approval:await P();break;case t.recordStateType.returned:await T();break;case t.recordStateType.published:await M();break}l.value=!1},w=async()=>{b.value=e.backoffice.tasks.archived.question,f.value=t.recordStateType.archived,s.showModalById(y)},I=async()=>{await S(t.recordStateType.archived)},G=async()=>{b.value=e.backoffice.tasks.submitted.question,f.value=t.recordStateType.submitted,s.showModalById(y)},o=async()=>{await S(t.recordStateType.submitted)},c=()=>{b.value=e.backoffice.tasks.returned.question,f.value=t.recordStateType.returned,l.value=!0,s.showModalById(y)},T=async()=>{await S(t.recordStateType.returned)},h=()=>{b.value=e.backoffice.tasks.published.question,f.value=t.recordStateType.published,F.value=null,s.showModalById(y)},M=async()=>{await S(t.recordStateType.published)},_=()=>{b.value=e.backoffice.tasks.draft.question,f.value=t.recordStateType.draft,s.showModalById(y)},B=async()=>{await S(t.recordStateType.draft)},O=()=>{b.value=e.backoffice.tasks.approval.question,f.value=t.recordStateType.approval,s.showModalById(y)},P=async()=>{await S(t.recordStateType.approval)},S=async n=>{s.closeModalById(y);let d=n==t.recordStateType.returned?g:null;const i=await r.service.changeState(r.itemId,r.itemVersion,n,F.value,d);if(i.code===t.responseCode.success){const q=Q.getMessage(e,f.value,r.objectTypeId);ie.success(q),r.recordStateTypeId===t.recordStateType.returned&&n===t.recordStateType.draft?j.push({name:r.editRoute,params:{[r.itemIdField]:s.encodeId(r.itemId),[r.itemVersionField]:s.encodeId(i.data.organizationVersion)}}):j.push({name:R.router.BACKOFFICE_TASKS_PAGE.name})}else i.code===t.responseCode.organizationDuplicate||i.code===t.responseCode.locationDuplicate||i.code===t.responseCode.pointOfCareDuplicate||i.code===t.responseCode.documentDuplicate||i.code===t.responseCode.serviceDuplicate?(F.value=i.data.key,E.value=s.createEmptyDataSource(i.data.newListDuplicates),s.showModalById("duplicated-names")):s.showErrorToastByResponseCode(i.code)};return W(()=>{D.on(R.emitter.OBJECT_LOADED,n=>{if(n.recordStateTypeId===t.recordStateType.draft){let d=[];switch(r.objectTypeId){case t.objectType.organization:d=ye.progressFields();break;case t.objectType.service:d=fe.progressFields();break;case t.objectType.pointOfCare:d=me.progressFields();break;case t.objectType.location:d=ge.progressFields();break;case t.objectType.document:d=be.progressFields();break}Q.calculatePercentage(n,d,i=>{C.value=i===100})}}),D.on(R.emitter.DUPLICATE_NAMES,async n=>{n?await M():F.value=null})}),te(()=>{D.off(R.emitter.OBJECT_LOADED),D.off(R.emitter.DUPLICATE_NAMES)}),(n,d)=>{const i=z("cbutton"),q=z("form-field"),H=z("row"),U=z("modal");return m(),V(A,null,[r.recordStateTypeId===a(t).recordStateType.draft?(m(),V(A,{key:0},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:w,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[3],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:G,disabled:p.loading||!a(C)||!r.canEdit},null,8,["title","type","size","disabled"])],64)):k("",!0),r.recordStateTypeId===a(t).recordStateType.submitted?(m(),L(i,{key:1,class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[4],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:O,disabled:p.loading},null,8,["title","type","size","disabled"])):k("",!0),r.recordStateTypeId===a(t).recordStateType.approval?(m(),V(A,{key:2},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[6],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:c,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[5],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:h,disabled:p.loading},null,8,["title","type","size","disabled"])],64)):k("",!0),r.recordStateTypeId===a(t).recordStateType.returned?(m(),V(A,{key:3},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:w,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[2],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:_,disabled:p.loading},null,8,["title","type","size","disabled"])],64)):k("",!0),u(U,{title:n._lang.common.confirmation,id:a(y),size:a(t).modalSize.medium},{body:J(()=>[ae("p",null,oe(a(b)),1),a(l)?(m(),L(H,{key:0},{default:J(()=>[u(q,{id:"refusalTypeId",class:"mb-3 col-12",modelValue:a(g).refusalTypeId,"onUpdate:modelValue":d[0]||(d[0]=X=>a(g).refusalTypeId=X),label:n._lang.label.refusalTypeId,type:a(t).inputs.multiselect,required:!0,placeholder:n._lang.common.selectOption,options:p.store.refusalTypeList},null,8,["modelValue","label","type","placeholder","options"]),u(q,{id:"refusal",class:"mb-3 col-12",modelValue:a(g).description,"onUpdate:modelValue":d[1]||(d[1]=X=>a(g).description=X),label:n._lang.label.refusal,type:a(t).inputs.textarea,maxlength:255,required:!0,disabled:!a(g).refusalTypeId},null,8,["modelValue","label","type","disabled"])]),_:1})):k("",!0)]),footer:J(()=>[u(i,{type:"secondary",size:"large",title:a(e).common.cancel,"data-bs-dismiss":"modal",onClick:$},null,8,["title"]),u(i,{type:"primary",title:a(e).common.confirm,onClick:N,disabled:a(l)&&(!a(g).description||!a(g).refusalTypeId)},null,8,["title","disabled"])]),_:1},8,["title","id","size"]),u(pe,{"data-source":a(E),name:r.name},null,8,["data-source","name"])],64)}}},Ve={__name:"detail-actions",props:{loading:{Boolean,required:!0},selectedLang:{type:[String,Number],required:!0},service:{type:Object,required:!0},backRoute:{type:String,required:!0},editRoute:{type:String,required:!0},itemIdField:{type:String,required:!0},formModel:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},itemVersionField:{type:String,required:!0},showRecordStateActions:{type:Boolean,default:!1},store:{type:Object,required:!0}},emits:["update:selectedLang","update:loading"],setup(p,{emit:r}){const e=p;re(async()=>{b.value=Q.getObjecTypeId(e.formModel),await g()}),W(()=>{});const D=x();Y();let j=v([]),y=v(!1),b=v(t.objectType.notApplicable);function f(o){y.value=o.width<576}const C=K({get(){return e.selectedLang},set(o){r("update:selectedLang",o)}}),l=K({get(){return e.loading},set(o){r("update:loading",o)}});async function g(){let o=await Te.getLanguages();s.validateResponse(o,null,()=>{j.value=o.data})}async function E(){let o=e.itemId,c=e.itemVersion;if(e.formModel.recordStateTypeId===t.recordStateType.submitted&&await F(),e.formModel.recordStateTypeId===t.recordStateType.published){const T=await $();await s.validateResponseAsync(T,null,async()=>{o=T.data[e.itemIdField],c=T.data[e.itemVersionField],N(o,c)})}else N(o,c)}async function F(){l.value=!0;const o=await e.service.changeStateToDraft(e.itemId,e.itemVersion);s.validateResponse(o,null,()=>{}),l.value=!1}async function $(){l.value=!0;const o=await e.service.update(e.formModel);return s.validateResponse(o,null,()=>{}),l.value=!1,o}function N(o,c){D.push({name:e.editRoute,params:{[e.itemIdField]:s.encodeId(o),[e.itemVersionField]:s.encodeId(c)}})}const w=K(()=>{var o,c,T,h,M,_,B,O,P,S,n,d,i,q,H,U;if(e.formModel.recordStateTypeId!=t.recordStateType.published&&e.formModel.recordStateTypeId!=t.recordStateType.draft&&e.formModel.recordStateTypeId!=t.recordStateType.submitted)return!1;switch(e.itemIdField){case"organizationId":return((o=e==null?void 0:e.formModel)==null?void 0:o.recordStateTypeId)!=7&&(I((c=e==null?void 0:e.formModel)==null?void 0:c.organizationId,t.permissions.organization)||I((h=(T=e==null?void 0:e.formModel)==null?void 0:T.parentOrganization)==null?void 0:h.id,t.permissions.organization));case"serviceId":return((M=e==null?void 0:e.formModel)==null?void 0:M.recordStateTypeId)!=7&&I((B=(_=e==null?void 0:e.formModel)==null?void 0:_.organization)==null?void 0:B.id,t.permissions.service);case"pointOfCareId":return((O=e==null?void 0:e.formModel)==null?void 0:O.recordStateTypeId)!=7&&I((S=(P=e==null?void 0:e.formModel)==null?void 0:P.organization)==null?void 0:S.id,t.permissions.pointOfCare);case"documentId":return((n=e==null?void 0:e.formModel)==null?void 0:n.recordStateTypeId)!=7&&I((i=(d=e==null?void 0:e.formModel)==null?void 0:d.organization)==null?void 0:i.id,t.permissions.document);case"locationId":return((q=e==null?void 0:e.formModel)==null?void 0:q.recordStateTypeId)!=7&&I((U=(H=e==null?void 0:e.formModel)==null?void 0:H.organization)==null?void 0:U.id,t.permissions.location)}});function I(o,c){return se.havePermissionOrganization(c.createEdit,o)}const G=K(()=>Q.getFieldByLangAndName(e.formModel,C.value,"name"));return(o,c)=>{const T=z("lang-selector"),h=z("cbutton"),M=z("cbutton-options-item"),_=z("cbutton-options"),B=ne("resize");return m(),V(A,null,[u(T,{options:a(j),selectedLang:a(C),"onUpdate:selectedLang":c[0]||(c[0]=O=>de(C)?C.value=O:null),disabled:a(l)},null,8,["options","selectedLang","disabled"]),e.showRecordStateActions?(m(),V(A,{key:1},[u(Se,{"record-state-type-id":e.formModel.recordStateTypeId,"object-type-id":a(b),loading:e.loading,service:e.service,"item-id":e.itemId,"item-version":e.itemVersion,canEdit:a(w),name:a(G),store:p.store,itemVersion:e.itemVersion,itemVersionField:e.itemVersionField,editRoute:e.editRoute},null,8,["record-state-type-id","object-type-id","loading","service","item-id","item-version","canEdit","name","store","itemVersion","itemVersionField","editRoute"]),a(w)&&e.formModel.recordStateTypeId!=a(t).recordStateType.returned?le((m(),L(_,{key:0,title:o._lang.common.actions,size:a(t).buttonSize.large,type:a(t).buttonType.secondary,disabled:a(l),class:ue(["d-sm-block d-none",{"dropdown-center":a(y)}])},{default:J(()=>[u(M,{title:o._lang.common.edit,onClick:ce(E,["prevent"]),disabled:a(l)},null,8,["title","onClick","disabled"])]),_:1},8,["title","size","type","disabled","class"])),[[B,f]]):k("",!0),a(w)?(m(),L(h,{key:1,class:"col-12 col-sm-auto d-sm-none",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:E,disabled:a(l)},null,8,["title","type","size","disabled"])):k("",!0)],64)):(m(),V(A,{key:0},[a(w)?(m(),L(h,{key:0,class:"col-12 col-sm-auto",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:E,disabled:a(l)},null,8,["title","type","size","disabled"])):k("",!0)],64))],64)}}};export{Ve as _};
