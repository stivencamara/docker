import{q as Y,D as Z,h as x,i as S,s as ee,j as s,b as W,l as R,v as t,d as te,r as k,o as p,e as _,m as a,F as q,a as u,y as I,c as L,w as J,f as ae,x as oe,Q as re,K as ie,E as K,M as se,X as ne,z as de,O as le,Y as ce,t as ue}from"./index-a3ba1ed7.js";import{b as pe}from"./refusal-478c260d.js";import{b as Q}from"./helpers-4d6c1969.js";import{p as me}from"./helpers-ae560b5a.js";import{o as ye}from"./helpers-41fd1e3d.js";import{d as be}from"./helpers-2771532d.js";import{s as fe}from"./helpers-10c1d19c.js";import{h as ge}from"./helpers-9164e810.js";import{s as Te}from"./settings-4e9392c0.js";const Se={__name:"record-state-actions",props:{loading:{Boolean,required:!0},canEdit:{Boolean,required:!0},recordStateTypeId:{required:!0},service:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},objectTypeId:{required:!0},name:{type:String},store:{type:Object,required:!0},itemVersionField:{type:String,required:!0},editRoute:{type:String,required:!0}},setup(O){const r=O,e=Y(),V=Z(),j=x();let m="record-state-type",y=S(null),b=S(0),z=S(!1),l=S(!1),f=ee({refusalTypeId:null,description:""}),A=S(s.createEmptyDataSource()),D=S(null);const $=()=>{l.value=!1},N=async()=>{switch(b.value){case t.recordStateType.archived:await v();break;case t.recordStateType.submitted:await o();break;case t.recordStateType.draft:await F();break;case t.recordStateType.approval:await P();break;case t.recordStateType.returned:await g();break;case t.recordStateType.published:await w();break}l.value=!1},C=async()=>{y.value=e.backoffice.tasks.archived.question,b.value=t.recordStateType.archived,s.showModalById(m)},v=async()=>{await T(t.recordStateType.archived)},G=async()=>{y.value=e.backoffice.tasks.submitted.question,b.value=t.recordStateType.submitted,s.showModalById(m)},o=async()=>{await T(t.recordStateType.submitted)},c=()=>{y.value=e.backoffice.tasks.returned.question,b.value=t.recordStateType.returned,l.value=!0,s.showModalById(m)},g=async()=>{await T(t.recordStateType.returned)},h=()=>{y.value=e.backoffice.tasks.published.question,b.value=t.recordStateType.published,D.value=null,s.showModalById(m)},w=async()=>{await T(t.recordStateType.published)},E=()=>{y.value=e.backoffice.tasks.draft.question,b.value=t.recordStateType.draft,s.showModalById(m)},F=async()=>{await T(t.recordStateType.draft)},B=()=>{y.value=e.backoffice.tasks.approval.question,b.value=t.recordStateType.approval,s.showModalById(m)},P=async()=>{await T(t.recordStateType.approval)},T=async n=>{s.closeModalById(m);let d=n==t.recordStateType.returned?f:null;const i=await r.service.changeState(r.itemId,r.itemVersion,n,D.value,d);if(i.code===t.responseCode.success){const M=Q.getMessage(e,b.value,r.objectTypeId);re.success(M),r.recordStateTypeId===t.recordStateType.returned&&n===t.recordStateType.draft?j.push({name:r.editRoute,params:{[r.itemIdField]:s.encodeId(r.itemId),[r.itemVersionField]:s.encodeId(i.data.organizationVersion)}}):j.push({name:R.router.BACKOFFICE_TASKS_PAGE.name})}else i.code===t.responseCode.organizationDuplicate||i.code===t.responseCode.locationDuplicate||i.code===t.responseCode.pointOfCareDuplicate||i.code===t.responseCode.documentDuplicate||i.code===t.responseCode.serviceDuplicate?(D.value=i.data.key,A.value=s.createEmptyDataSource(i.data.newListDuplicates),s.showModalById("duplicated-names")):s.showErrorToastByResponseCode(i.code)};return W(()=>{V.on(R.emitter.OBJECT_LOADED,n=>{if(n.recordStateTypeId===t.recordStateType.draft){let d=[];switch(r.objectTypeId){case t.objectType.organization:d=ye.progressFields();break;case t.objectType.service:d=fe.progressFields();break;case t.objectType.pointOfCare:d=me.progressFields();break;case t.objectType.location:d=ge.progressFields();break;case t.objectType.document:d=be.progressFields();break}Q.calculatePercentage(n,d,i=>{z.value=i===100})}}),V.on(R.emitter.DUPLICATE_NAMES,async n=>{n?await w():D.value=null})}),te(()=>{V.off(R.emitter.OBJECT_LOADED),V.off(R.emitter.DUPLICATE_NAMES)}),(n,d)=>{const i=k("cbutton"),M=k("form-field"),H=k("row"),U=k("modal");return p(),_(q,null,[r.recordStateTypeId===a(t).recordStateType.draft?(p(),_(q,{key:0},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:C,disabled:r.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[3],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:G,disabled:r.loading||!a(z)||!r.canEdit},null,8,["title","type","size","disabled"])],64)):I("",!0),r.recordStateTypeId===a(t).recordStateType.submitted?(p(),L(i,{key:1,class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[4],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:B,disabled:r.loading},null,8,["title","type","size","disabled"])):I("",!0),r.recordStateTypeId===a(t).recordStateType.approval?(p(),_(q,{key:2},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[6],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:c,disabled:r.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[5],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:h,disabled:r.loading},null,8,["title","type","size","disabled"])],64)):I("",!0),r.recordStateTypeId===a(t).recordStateType.returned?(p(),_(q,{key:3},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:C,disabled:r.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[2],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:E,disabled:r.loading},null,8,["title","type","size","disabled"])],64)):I("",!0),u(U,{title:n._lang.common.confirmation,id:a(m),size:a(t).modalSize.medium},{body:J(()=>[ae("p",null,oe(a(y)),1),a(l)?(p(),L(H,{key:0},{default:J(()=>[u(M,{id:"refusalTypeId",class:"mb-3 col-12",modelValue:a(f).refusalTypeId,"onUpdate:modelValue":d[0]||(d[0]=X=>a(f).refusalTypeId=X),label:n._lang.label.refusalTypeId,type:a(t).inputs.multiselect,required:!0,placeholder:n._lang.common.selectOption,options:O.store.refusalTypeList},null,8,["modelValue","label","type","placeholder","options"]),u(M,{id:"refusal",class:"mb-3 col-12",modelValue:a(f).description,"onUpdate:modelValue":d[1]||(d[1]=X=>a(f).description=X),label:n._lang.label.refusal,type:a(t).inputs.textarea,maxlength:255,required:!0,disabled:!a(f).refusalTypeId},null,8,["modelValue","label","type","disabled"])]),_:1})):I("",!0)]),footer:J(()=>[u(i,{type:"secondary",size:"large",title:a(e).common.cancel,"data-bs-dismiss":"modal",onClick:$},null,8,["title"]),u(i,{type:"primary",title:a(e).common.confirm,onClick:N,disabled:a(l)&&(!a(f).description||!a(f).refusalTypeId)},null,8,["title","disabled"])]),_:1},8,["title","id","size"]),u(pe,{"data-source":a(A),name:r.name},null,8,["data-source","name"])],64)}}},qe={__name:"detail-actions",props:{loading:{Boolean,required:!0},selectedLang:{type:[String,Number],required:!0},service:{type:Object,required:!0},backRoute:{type:String,required:!0},editRoute:{type:String,required:!0},itemIdField:{type:String,required:!0},formModel:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},itemVersionField:{type:String,required:!0},showRecordStateActions:{type:Boolean,default:!1},store:{type:Object,required:!0}},emits:["update:selectedLang","update:loading"],setup(O,{emit:r}){const e=O;ie(async()=>{y.value=Q.getObjecTypeId(e.formModel),await f()}),W(()=>{});const V=x();Y();let j=S([]),m=S(!1),y=S(t.objectType.notApplicable);function b(o){m.value=o.width<576}const z=K({get(){return e.selectedLang},set(o){r("update:selectedLang",o)}}),l=K({get(){return e.loading},set(o){r("update:loading",o)}});async function f(){let o=await Te.getLanguages();s.validateResponse(o,null,()=>{j.value=o.data})}async function A(){let o=e.itemId,c=e.itemVersion;if(e.formModel.recordStateTypeId===t.recordStateType.submitted&&await D(),e.formModel.recordStateTypeId===t.recordStateType.published){const g=await $();await s.validateResponseAsync(g,null,async()=>{o=g.data[e.itemIdField],c=g.data[e.itemVersionField],N(o,c)})}else N(o,c)}async function D(){l.value=!0;const o=await e.service.changeStateToDraft(e.itemId,e.itemVersion);s.validateResponse(o,null,()=>{}),l.value=!1}async function $(){l.value=!0;const o=await e.service.update(e.formModel);return s.validateResponse(o,null,()=>{}),l.value=!1,o}function N(o,c){V.push({name:e.editRoute,params:{[e.itemIdField]:s.encodeId(o),[e.itemVersionField]:s.encodeId(c)}})}const C=K(()=>{var o,c,g,h,w,E,F,B,P,T,n,d,i,M,H,U;if(e.formModel.recordStateTypeId!=t.recordStateType.published&&e.formModel.recordStateTypeId!=t.recordStateType.draft&&e.formModel.recordStateTypeId!=t.recordStateType.submitted||e.formModel.recordStateTypeId==t.recordStateType.published&&e.formModel.parentOrganization==null)return!1;switch(e.itemIdField){case"organizationId":return((o=e==null?void 0:e.formModel)==null?void 0:o.recordStateTypeId)!=7&&(v((c=e==null?void 0:e.formModel)==null?void 0:c.organizationId,t.permissions.organization)||v((h=(g=e==null?void 0:e.formModel)==null?void 0:g.parentOrganization)==null?void 0:h.id,t.permissions.organization));case"serviceId":return((w=e==null?void 0:e.formModel)==null?void 0:w.recordStateTypeId)!=7&&v((F=(E=e==null?void 0:e.formModel)==null?void 0:E.organization)==null?void 0:F.id,t.permissions.service);case"pointOfCareId":return((B=e==null?void 0:e.formModel)==null?void 0:B.recordStateTypeId)!=7&&v((T=(P=e==null?void 0:e.formModel)==null?void 0:P.organization)==null?void 0:T.id,t.permissions.pointOfCare);case"documentId":return((n=e==null?void 0:e.formModel)==null?void 0:n.recordStateTypeId)!=7&&v((i=(d=e==null?void 0:e.formModel)==null?void 0:d.organization)==null?void 0:i.id,t.permissions.document);case"locationId":return((M=e==null?void 0:e.formModel)==null?void 0:M.recordStateTypeId)!=7&&v((U=(H=e==null?void 0:e.formModel)==null?void 0:H.organization)==null?void 0:U.id,t.permissions.location)}});function v(o,c){return se.havePermissionOrganization(c.createEdit,o)}const G=K(()=>Q.getFieldByLangAndName(e.formModel,z.value,"name"));return(o,c)=>{const g=k("lang-selector"),h=k("cbutton"),w=k("cbutton-options-item"),E=k("cbutton-options"),F=ne("resize");return p(),_(q,null,[u(g,{options:a(j),selectedLang:a(z),"onUpdate:selectedLang":c[0]||(c[0]=B=>de(z)?z.value=B:null),disabled:a(l)},null,8,["options","selectedLang","disabled"]),e.showRecordStateActions?(p(),_(q,{key:1},[u(Se,{"record-state-type-id":e.formModel.recordStateTypeId,"object-type-id":a(y),loading:e.loading,service:e.service,"item-id":e.itemId,"item-version":e.itemVersion,canEdit:a(C),name:a(G),store:O.store,itemVersion:e.itemVersion,itemVersionField:e.itemVersionField,editRoute:e.editRoute},null,8,["record-state-type-id","object-type-id","loading","service","item-id","item-version","canEdit","name","store","itemVersion","itemVersionField","editRoute"]),a(C)&&e.formModel.recordStateTypeId!=a(t).recordStateType.returned?le((p(),L(E,{key:0,title:o._lang.common.actions,size:a(t).buttonSize.large,type:a(t).buttonType.secondary,disabled:a(l),class:ue(["d-sm-block d-none",{"dropdown-center":a(m)}])},{default:J(()=>[u(w,{title:o._lang.common.edit,onClick:ce(A,["prevent"]),disabled:a(l)},null,8,["title","onClick","disabled"])]),_:1},8,["title","size","type","disabled","class"])),[[F,b]]):I("",!0),a(C)?(p(),L(h,{key:1,class:"col-12 col-sm-auto d-sm-none",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:A,disabled:a(l)},null,8,["title","type","size","disabled"])):I("",!0)],64)):(p(),_(q,{key:0},[a(C)?(p(),L(h,{key:0,class:"col-12 col-sm-auto",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:A,disabled:a(l)},null,8,["title","type","size","disabled"])):I("",!0)],64))],64)}}};export{qe as _};
