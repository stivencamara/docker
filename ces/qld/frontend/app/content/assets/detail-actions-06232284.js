import{z as Z,M as X,s as x,r as v,a as ee,u as s,n as W,x as j,i as t,q as te,b as z,o as m,c as V,g as a,F as A,e as u,B as k,l as L,w as K,d as ae,t as oe,Q as ie,J as re,G as J,U as se,Y as ne,D as le,O as de,Z as ce,A as ue}from"./index-5b4ebf84.js";import{b as pe}from"./refusal-5d03193c.js";import{b as G}from"./helpers-4796f1a9.js";import{p as me}from"./helpers-56107f9e.js";import{o as ye}from"./helpers-991a1d67.js";import{d as be}from"./helpers-138c884f.js";import{s as fe}from"./helpers-28a0442c.js";import{h as ge}from"./helpers-c8652456.js";import{s as Te}from"./settings-fd6ffbf1.js";const Se={__name:"record-state-actions",props:{loading:{Boolean,required:!0},canEdit:{Boolean,required:!0},recordStateTypeId:{required:!0},service:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},objectTypeId:{required:!0},name:{type:String},store:{type:Object,required:!0},itemVersionField:{type:String,required:!0},editRoute:{type:String,required:!0}},setup(p){const r=p,e=Z(),D=X(),R=x();let y="record-state-type",b=v(null),f=v(0),C=v(!1),d=v(!1),g=ee({refusalTypeId:null,description:""}),B=v(s.createEmptyDataSource()),F=v(null);const Q=()=>{d.value=!1},N=async()=>{switch(f.value){case t.recordStateType.archived:await I();break;case t.recordStateType.submitted:await o();break;case t.recordStateType.draft:await E();break;case t.recordStateType.approval:await P();break;case t.recordStateType.returned:await T();break;case t.recordStateType.published:await M();break}d.value=!1},w=async()=>{b.value=e.backoffice.tasks.archived.question,f.value=t.recordStateType.archived,s.showModalById(y)},I=async()=>{await S(t.recordStateType.archived)},$=async()=>{b.value=e.backoffice.tasks.submitted.question,f.value=t.recordStateType.submitted,s.showModalById(y)},o=async()=>{await S(t.recordStateType.submitted)},c=()=>{b.value=e.backoffice.tasks.returned.question,f.value=t.recordStateType.returned,d.value=!0,s.showModalById(y)},T=async()=>{await S(t.recordStateType.returned)},h=()=>{b.value=e.backoffice.tasks.published.question,f.value=t.recordStateType.published,F.value=null,s.showModalById(y)},M=async()=>{await S(t.recordStateType.published)},_=()=>{b.value=e.backoffice.tasks.draft.question,f.value=t.recordStateType.draft,s.showModalById(y)},E=async()=>{await S(t.recordStateType.draft)},O=()=>{b.value=e.backoffice.tasks.approval.question,f.value=t.recordStateType.approval,s.showModalById(y)},P=async()=>{await S(t.recordStateType.approval)},S=async n=>{s.closeModalById(y);let l=n==t.recordStateType.returned?g:null;const i=await r.service.changeState(r.itemId,r.itemVersion,n,F.value,l);if(i.code===t.responseCode.success){const q=G.getMessage(e,f.value,r.objectTypeId);ie.success(q),r.recordStateTypeId===t.recordStateType.returned&&n===t.recordStateType.draft?R.push({name:r.editRoute,params:{[r.itemIdField]:s.encodeId(r.itemId),[r.itemVersionField]:s.encodeId(i.data.organizationVersion)}}):R.push({name:j.router.BACKOFFICE_TASKS_PAGE.name})}else i.code===t.responseCode.organizationDuplicate||i.code===t.responseCode.locationDuplicate||i.code===t.responseCode.pointOfCareDuplicate||i.code===t.responseCode.documentDuplicate||i.code===t.responseCode.serviceDuplicate?(F.value=i.data.key,B.value=s.createEmptyDataSource(i.data.newListDuplicates),s.showModalById("duplicated-names")):s.showErrorToastByResponseCode(i.code)};return W(()=>{D.on(j.emitter.OBJECT_LOADED,n=>{if(n.recordStateTypeId===t.recordStateType.draft){let l=[];switch(r.objectTypeId){case t.objectType.organization:l=ye.progressFields();break;case t.objectType.service:l=fe.progressFields();break;case t.objectType.pointOfCare:l=me.progressFields();break;case t.objectType.location:l=ge.progressFields();break;case t.objectType.document:l=be.progressFields();break}G.calculatePercentage(n,l,i=>{C.value=i===100})}}),D.on(j.emitter.DUPLICATE_NAMES,async n=>{n?await M():F.value=null})}),te(()=>{D.off(j.emitter.OBJECT_LOADED),D.off(j.emitter.DUPLICATE_NAMES)}),(n,l)=>{const i=z("cbutton"),q=z("form-field"),U=z("row"),H=z("modal");return m(),V(A,null,[r.recordStateTypeId===a(t).recordStateType.draft?(m(),V(A,{key:0},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:w,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[3],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:$,disabled:p.loading||!a(C)||!r.canEdit},null,8,["title","type","size","disabled"])],64)):k("",!0),r.recordStateTypeId===a(t).recordStateType.submitted?(m(),L(i,{key:1,class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[4],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:O,disabled:p.loading},null,8,["title","type","size","disabled"])):k("",!0),r.recordStateTypeId===a(t).recordStateType.approval?(m(),V(A,{key:2},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[6],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:c,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[5],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:h,disabled:p.loading},null,8,["title","type","size","disabled"])],64)):k("",!0),r.recordStateTypeId===a(t).recordStateType.returned?(m(),V(A,{key:3},[u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:w,disabled:p.loading},null,8,["title","type","size","disabled"]),u(i,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[2],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:_,disabled:p.loading},null,8,["title","type","size","disabled"])],64)):k("",!0),u(H,{title:n._lang.common.confirmation,id:a(y),size:a(t).modalSize.medium},{body:K(()=>[ae("p",null,oe(a(b)),1),a(d)?(m(),L(U,{key:0},{default:K(()=>[u(q,{id:"refusalTypeId",class:"mb-3 col-12",modelValue:a(g).refusalTypeId,"onUpdate:modelValue":l[0]||(l[0]=Y=>a(g).refusalTypeId=Y),label:n._lang.label.refusalTypeId,type:a(t).inputs.multiselect,required:!0,placeholder:n._lang.common.selectOption,options:p.store.refusalTypeList},null,8,["modelValue","label","type","placeholder","options"]),u(q,{id:"refusal",class:"mb-3 col-12",modelValue:a(g).description,"onUpdate:modelValue":l[1]||(l[1]=Y=>a(g).description=Y),label:n._lang.label.refusal,type:a(t).inputs.textarea,maxlength:255,required:!0,disabled:!a(g).refusalTypeId},null,8,["modelValue","label","type","disabled"])]),_:1})):k("",!0)]),footer:K(()=>[u(i,{type:"secondary",size:"large",title:a(e).common.cancel,"data-bs-dismiss":"modal",onClick:Q},null,8,["title"]),u(i,{type:"primary",title:a(e).common.confirm,onClick:N,disabled:a(d)&&(!a(g).description||!a(g).refusalTypeId)},null,8,["title","disabled"])]),_:1},8,["title","id","size"]),u(pe,{"data-source":a(B),name:r.name},null,8,["data-source","name"])],64)}}},Ve={__name:"detail-actions",props:{loading:{Boolean,required:!0},selectedLang:{type:[String,Number],required:!0},service:{type:Object,required:!0},backRoute:{type:String,required:!0},editRoute:{type:String,required:!0},itemIdField:{type:String,required:!0},formModel:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},itemVersionField:{type:String,required:!0},showRecordStateActions:{type:Boolean,default:!1},store:{type:Object,required:!0}},emits:["update:selectedLang","update:loading"],setup(p,{emit:r}){const e=p;re(async()=>{b.value=G.getObjecTypeId(e.formModel),await g()}),W(()=>{});const D=x();Z();let R=v([]),y=v(!1),b=v(t.objectType.notApplicable);function f(o){y.value=o.width<576}const C=J({get(){return e.selectedLang},set(o){r("update:selectedLang",o)}}),d=J({get(){return e.loading},set(o){r("update:loading",o)}});async function g(){let o=await Te.getLanguages();s.validateResponse(o,null,()=>{R.value=o.data})}async function B(){let o=e.itemId,c=e.itemVersion;if(e.formModel.recordStateTypeId===t.recordStateType.submitted&&await F(),e.formModel.recordStateTypeId===t.recordStateType.published){const T=await Q();await s.validateResponseAsync(T,null,async()=>{o=T.data[e.itemIdField],c=T.data[e.itemVersionField],N(o,c)})}else N(o,c)}async function F(){d.value=!0;const o=await e.service.changeStateToDraft(e.itemId,e.itemVersion);s.validateResponse(o,null,()=>{}),d.value=!1}async function Q(){d.value=!0;const o=await e.service.update(e.formModel);return s.validateResponse(o,null,()=>{}),d.value=!1,o}function N(o,c){D.push({name:e.editRoute,params:{[e.itemIdField]:s.encodeId(o),[e.itemVersionField]:s.encodeId(c)}})}const w=J(()=>{var o,c,T,h,M,_,E,O,P,S,n,l,i,q,U,H;switch(e.itemIdField){case"organizationId":return((o=e==null?void 0:e.formModel)==null?void 0:o.recordStateTypeId)!=7&&(I((c=e==null?void 0:e.formModel)==null?void 0:c.organizationId,t.permissions.organization)||I((h=(T=e==null?void 0:e.formModel)==null?void 0:T.parentOrganization)==null?void 0:h.id,t.permissions.organization));case"serviceId":return((M=e==null?void 0:e.formModel)==null?void 0:M.recordStateTypeId)!=7&&I((E=(_=e==null?void 0:e.formModel)==null?void 0:_.organization)==null?void 0:E.id,t.permissions.service);case"pointOfCareId":return((O=e==null?void 0:e.formModel)==null?void 0:O.recordStateTypeId)!=7&&I((S=(P=e==null?void 0:e.formModel)==null?void 0:P.organization)==null?void 0:S.id,t.permissions.pointOfCare);case"documentId":return((n=e==null?void 0:e.formModel)==null?void 0:n.recordStateTypeId)!=7&&I((i=(l=e==null?void 0:e.formModel)==null?void 0:l.organization)==null?void 0:i.id,t.permissions.document);case"locationId":return((q=e==null?void 0:e.formModel)==null?void 0:q.recordStateTypeId)!=7&&I((H=(U=e==null?void 0:e.formModel)==null?void 0:U.organization)==null?void 0:H.id,t.permissions.location)}});function I(o,c){return se.havePermissionOrganization(c.createEdit,o)}const $=J(()=>G.getFieldByLangAndName(e.formModel,C.value,"name"));return(o,c)=>{const T=z("lang-selector"),h=z("cbutton"),M=z("cbutton-options-item"),_=z("cbutton-options"),E=ne("resize");return m(),V(A,null,[u(T,{options:a(R),selectedLang:a(C),"onUpdate:selectedLang":c[0]||(c[0]=O=>le(C)?C.value=O:null),disabled:a(d)},null,8,["options","selectedLang","disabled"]),e.showRecordStateActions?(m(),V(A,{key:1},[u(Se,{"record-state-type-id":e.formModel.recordStateTypeId,"object-type-id":a(b),loading:e.loading,service:e.service,"item-id":e.itemId,"item-version":e.itemVersion,canEdit:a(w),name:a($),store:p.store,itemVersion:e.itemVersion,itemVersionField:e.itemVersionField,editRoute:e.editRoute},null,8,["record-state-type-id","object-type-id","loading","service","item-id","item-version","canEdit","name","store","itemVersion","itemVersionField","editRoute"]),a(w)&&e.formModel.recordStateTypeId!=a(t).recordStateType.returned?de((m(),L(_,{key:0,title:o._lang.common.actions,size:a(t).buttonSize.large,type:a(t).buttonType.secondary,disabled:a(d),class:ue(["d-sm-block d-none",{"dropdown-center":a(y)}])},{default:K(()=>[u(M,{title:o._lang.common.edit,onClick:ce(B,["prevent"]),disabled:a(d)},null,8,["title","onClick","disabled"])]),_:1},8,["title","size","type","disabled","class"])),[[E,f]]):k("",!0),a(w)?(m(),L(h,{key:1,class:"col-12 col-sm-auto d-sm-none",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:B,disabled:a(d)},null,8,["title","type","size","disabled"])):k("",!0)],64)):(m(),V(A,{key:0},[a(w)?(m(),L(h,{key:0,class:"col-12 col-sm-auto",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:B,disabled:a(d)},null,8,["title","type","size","disabled"])):k("",!0)],64))],64)}}};export{Ve as _};
