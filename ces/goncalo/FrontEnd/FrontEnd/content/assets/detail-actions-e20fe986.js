import{i as ae,h as re,g as oe,r as S,j as se,u as d,P as E,v as t,o as ie,C as N,a as ne,l as M,c as p,e as C,s as a,F as h,q as u,A as v,m as q,n as $,p as de,x as le,B as te,N as ce,k as H,$ as ue,L as me,Q as pe,a0 as ye,K as fe}from"./index-ecfd29ec.js";import{_ as be}from"./extinct-confirm-b2410bd5.js";import{b as ge}from"./refusal-64a629f9.js";import{b as J}from"./helpers-42575dad.js";import{p as Te}from"./helpers-52c527b5.js";import{o as Se}from"./helpers-aa27db39.js";import{d as ve}from"./helpers-ae409286.js";import{s as Ie}from"./helpers-29ad8680.js";import{h as ke}from"./helpers-3069747c.js";import{s as ze}from"./settings-1fa7723b.js";const Ce={__name:"record-state-actions",props:{loading:{Boolean,required:!0},canEdit:{Boolean,required:!0},recordStateTypeId:{required:!0},service:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},objectTypeId:{required:!0},name:{type:String},store:{type:Object,required:!0},itemVersionField:{type:String,required:!0},itemIdField:{type:String,required:!0},editRoute:{type:String,required:!0}},setup(R){const i=R,e=ae(),D=re(),j=oe();let b="record-state-type",I=S(null),g=S(0),L=S(!1),w=S(!1),y=se({refusalTypeId:null,description:""}),c=S(d.createEmptyDataSource()),A=S(null);const _=S(E.havePermission(t.permissions[t.objectTypeId[i.objectTypeId]].approve)),Q=()=>{w.value=!1},G=async()=>{switch(g.value){case t.recordStateType.archived:await P();break;case t.recordStateType.submitted:await z();break;case t.recordStateType.draft:await m();break;case t.recordStateType.approval:await k();break;case t.recordStateType.returned:await X();break;case t.recordStateType.published:await o();break}w.value=!1},U=async()=>{I.value=e.backoffice.tasks.archived.question,g.value=t.recordStateType.archived,d.showModalById(b)},P=async()=>{await T(t.recordStateType.archived)},F=async()=>{I.value=e.backoffice.tasks.submitted.question,g.value=t.recordStateType.submitted,d.showModalById(b)},z=async()=>{await T(t.recordStateType.submitted)},W=()=>{I.value=e.backoffice.tasks.returned.question,g.value=t.recordStateType.returned,w.value=!0,d.showModalById(b)},X=async()=>{await T(t.recordStateType.returned)},Y=()=>{I.value=e.backoffice.tasks.published.question,g.value=t.recordStateType.published,A.value=null,d.showModalById(b)},o=async()=>{await T(t.recordStateType.published)},s=()=>{I.value=e.backoffice.tasks.draft.question,g.value=t.recordStateType.draft,d.showModalById(b)},m=async()=>{await T(t.recordStateType.draft)},f=()=>{I.value=e.backoffice.tasks.approval.question,g.value=t.recordStateType.approval,d.showModalById(b)},k=async()=>{await T(t.recordStateType.approval)},T=async n=>{d.closeModalById(b);let l=n==t.recordStateType.returned?y:null;const r=await i.service.changeState(i.itemId,i.itemVersion,n,A.value,l);if(r.code===t.responseCode.success){const V=J.getMessage(e,g.value,i.objectTypeId);te.success(V),i.recordStateTypeId===t.recordStateType.returned&&n===t.recordStateType.draft?O(r.data[i.itemIdField],r.data[i.itemVersionField]):j.push({name:N.router.BACKOFFICE_TASKS_PAGE.name})}else r.code===t.responseCode.organizationDuplicate||r.code===t.responseCode.locationDuplicate||r.code===t.responseCode.pointOfCareDuplicate||r.code===t.responseCode.documentDuplicate||r.code===t.responseCode.serviceDuplicate?(A.value=r.data.key,c.value=d.createEmptyDataSource(r.data.newListDuplicates),d.showModalById("duplicated-names")):d.showErrorToastByResponseCode(r.code)};function O(n,l){n==null||l==null?te.error("Erro"):j.push({name:i.editRoute,params:{[i.itemIdField]:d.encodeId(n),[i.itemVersionField]:d.encodeId(l)}})}return ie(()=>{D.on(N.emitter.OBJECT_LOADED,n=>{if(n.recordStateTypeId===t.recordStateType.draft){let l=[];switch(i.objectTypeId){case t.objectType.organization:l=Se.progressFields();break;case t.objectType.service:l=Ie.progressFields();break;case t.objectType.pointOfCare:l=Te.progressFields();break;case t.objectType.location:l=ke.progressFields();break;case t.objectType.document:l=ve.progressFields();break}J.calculatePercentage(n,l,r=>{L.value=r===100})}}),D.on(N.emitter.DUPLICATE_NAMES,async n=>{n?await o():A.value=null})}),ne(()=>{D.off(N.emitter.OBJECT_LOADED),D.off(N.emitter.DUPLICATE_NAMES)}),(n,l)=>{const r=M("cbutton"),V=M("form-field"),x=M("row"),K=M("modal");return p(),C(h,null,[i.recordStateTypeId===a(t).recordStateType.draft?(p(),C(h,{key:0},[u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:U,disabled:i.loading},null,8,["title","type","size","disabled"]),u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[3],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:F,disabled:i.loading||!a(L)||!i.canEdit},null,8,["title","type","size","disabled"])],64)):v("",!0),i.recordStateTypeId===a(t).recordStateType.submitted?(p(),C(h,{key:1},[_.value?(p(),q(r,{key:0,class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[4],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:f,disabled:i.loading},null,8,["title","type","size","disabled"])):v("",!0)],64)):v("",!0),i.recordStateTypeId===a(t).recordStateType.approval&&_.value?(p(),C(h,{key:2},[u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[6],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:W,disabled:i.loading},null,8,["title","type","size","disabled"]),u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[5],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:Y,disabled:i.loading},null,8,["title","type","size","disabled"])],64)):v("",!0),i.recordStateTypeId===a(t).recordStateType.returned&&_.value?(p(),C(h,{key:3},[u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[7],type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:U,disabled:i.loading},null,8,["title","type","size","disabled"]),u(r,{class:"col-12 col-sm-auto",title:a(e).enums.recordStateTypeAction[2],type:a(t).buttonType.primary,size:a(t).buttonSize.large,onClick:s,disabled:i.loading},null,8,["title","type","size","disabled"])],64)):v("",!0),u(K,{title:n._lang.common.confirmation,id:a(b),size:a(t).modalSize.medium},{body:$(()=>[de("p",null,le(a(I)),1),a(w)?(p(),q(x,{key:0},{default:$(()=>[u(V,{id:"refusalTypeId",class:"mb-3 col-12",modelValue:a(y).refusalTypeId,"onUpdate:modelValue":l[0]||(l[0]=B=>a(y).refusalTypeId=B),label:n._lang.label.refusalTypeId,type:a(t).inputs.multiselect,required:!0,placeholder:n._lang.common.selectOption,options:R.store.refusalTypeList},null,8,["modelValue","label","type","placeholder","options"]),u(V,{id:"refusal",class:"mb-3 col-12",modelValue:a(y).description,"onUpdate:modelValue":l[1]||(l[1]=B=>a(y).description=B),label:n._lang.label.refusal,type:a(t).inputs.textarea,maxlength:255,required:!0,disabled:!a(y).refusalTypeId},null,8,["modelValue","label","type","disabled"])]),_:1})):v("",!0)]),footer:$(()=>[u(r,{type:"secondary",size:"large",title:a(e).common.cancel,"data-bs-dismiss":"modal",onClick:Q},null,8,["title"]),u(r,{type:"primary",title:a(e).common.confirm,onClick:G,disabled:a(w)&&(!a(y).description||!a(y).refusalTypeId)},null,8,["title","disabled"])]),_:1},8,["title","id","size"]),u(ge,{"data-source":a(c),name:i.name},null,8,["data-source","name"])],64)}}},Be={__name:"detail-actions",props:{loading:{Boolean,required:!0},selectedLang:{type:[String,Number],required:!0},service:{type:Object,required:!0},backRoute:{type:String,required:!0},editRoute:{type:String,required:!0},itemIdField:{type:String,required:!0},formModel:{type:Object,required:!0},itemId:{type:Number,required:!0},itemVersion:{type:Number,required:!0},itemVersionField:{type:String,required:!0},showRecordStateActions:{type:Boolean,default:!1},store:{type:Object,required:!0}},emits:["update:selectedLang","update:loading"],setup(R,{emit:i}){const e=R;ce(async()=>{g.value=J.getObjecTypeId(e.formModel),await A()}),ie(()=>{});const D=oe();ae();const j="confirm-extinct-submit";let b=S([]),I=S(!1),g=S(t.objectType.notApplicable),L=S(null);function w(o){I.value=o.width<576}const y=H({get(){return e.selectedLang},set(o){i("update:selectedLang",o)}}),c=H({get(){return e.loading},set(o){i("update:loading",o)}});async function A(){let o=await ze.getLanguages();d.validateResponse(o,null,()=>{b.value=o.data})}async function _(){let o=e.itemId,s=e.itemVersion;if(e.formModel.recordStateTypeId===t.recordStateType.submitted&&await G(),e.formModel.recordStateTypeId===t.recordStateType.published){const m=await U();await d.validateResponseAsync(m,null,async()=>{o=m.data[e.itemIdField],s=m.data[e.itemVersionField],P(o,s)})}else P(o,s)}async function Q(){c.value=!0;const o=await e.service.clone(e.itemId,e.itemVersion);await d.validateResponseAsync(o,null,async()=>{let s=o.data[e.itemIdField],m=o.data[e.itemVersionField];P(s,m)}),c.value=!1}async function G(){c.value=!0;const o=await e.service.changeStateToDraft(e.itemId,e.itemVersion);d.validateResponse(o,null,()=>{}),c.value=!1}async function U(){c.value=!0;const o=await e.service.update(e.formModel);return d.validateResponse(o,null,()=>{}),c.value=!1,o}function P(o,s){D.push({name:e.editRoute,params:{[e.itemIdField]:d.encodeId(o),[e.itemVersionField]:d.encodeId(s)}})}const F=H(()=>{var o,s,m,f,k,T,O,n,l,r,V,x,K,B,Z,ee;if(e.formModel.recordStateTypeId!==t.recordStateType.published&&e.formModel.recordStateTypeId!==t.recordStateType.draft&&e.formModel.recordStateTypeId!==t.recordStateType.approval&&e.formModel.recordStateTypeId!==t.recordStateType.submitted||e.formModel.recordStateTypeId===t.recordStateType.published&&e.formModel.parentOrganization===null&&e.itemIdField==="organizationId")return!1;switch(e.itemIdField){case"organizationId":return((o=e==null?void 0:e.formModel)==null?void 0:o.recordStateTypeId)!=7&&(z((s=e==null?void 0:e.formModel)==null?void 0:s.organizationId,t.permissions.organization)||z((f=(m=e==null?void 0:e.formModel)==null?void 0:m.parentOrganization)==null?void 0:f.id,t.permissions.organization));case"serviceId":return((k=e==null?void 0:e.formModel)==null?void 0:k.recordStateTypeId)!=7&&z((O=(T=e==null?void 0:e.formModel)==null?void 0:T.organization)==null?void 0:O.id,t.permissions.service);case"pointOfCareId":return((n=e==null?void 0:e.formModel)==null?void 0:n.recordStateTypeId)!=7&&z((r=(l=e==null?void 0:e.formModel)==null?void 0:l.organization)==null?void 0:r.id,t.permissions.pointOfCare);case"documentId":return((V=e==null?void 0:e.formModel)==null?void 0:V.recordStateTypeId)!=7&&z((K=(x=e==null?void 0:e.formModel)==null?void 0:x.organization)==null?void 0:K.id,t.permissions.document);case"locationId":return((B=e==null?void 0:e.formModel)==null?void 0:B.recordStateTypeId)!=7&&z((ee=(Z=e==null?void 0:e.formModel)==null?void 0:Z.organization)==null?void 0:ee.id,t.permissions.location)}});function z(o,s){return o==null&&e.formModel.recordStateTypeId===t.recordStateType.draft?E.havePermission(s.createEdit):E.havePermissionOrganization(s.createEdit,o)}const W=H(()=>J.getFieldByLangAndName(e.formModel,y.value,"name")),X=H(()=>{var o,s,m,f,k;if(e.formModel.recordStateTypeId!=t.recordStateType.published)return!1;switch(e.itemIdField){case"organizationId":return E.havePermissionOrganization(t.permissions.super.approve,(o=e==null?void 0:e.formModel)==null?void 0:o.organizationId)||E.havePermissionOrganization(t.permissions.super.approve,(m=(s=e==null?void 0:e.formModel)==null?void 0:s.parentOrganization)==null?void 0:m.id);case"serviceId":case"pointOfCareId":case"documentId":case"locationId":return E.havePermissionOrganization(t.permissions.super.approve,(k=(f=e==null?void 0:e.formModel)==null?void 0:f.organization)==null?void 0:k.id)}});function Y(){d.showModalById(j),L.value.setDate(e.formModel.endDate)}return(o,s)=>{const m=M("lang-selector"),f=M("cbutton"),k=M("cbutton-options-item"),T=M("cbutton-options"),O=ue("resize");return p(),C(h,null,[u(m,{options:a(b),selectedLang:a(y),"onUpdate:selectedLang":s[0]||(s[0]=n=>me(y)?y.value=n:null),disabled:a(c)},null,8,["options","selectedLang","disabled"]),e.showRecordStateActions?(p(),C(h,{key:1},[u(Ce,{"record-state-type-id":e.formModel.recordStateTypeId,"object-type-id":a(g),loading:e.loading,service:e.service,"item-id":e.itemId,"item-version":e.itemVersion,canEdit:a(F),name:a(W),store:R.store,itemVersion:e.itemVersion,itemVersionField:e.itemVersionField,itemIdField:e.itemIdField,editRoute:e.editRoute},null,8,["record-state-type-id","object-type-id","loading","service","item-id","item-version","canEdit","name","store","itemVersion","itemVersionField","itemIdField","editRoute"]),a(F)&&e.formModel.recordStateTypeId!=a(t).recordStateType.returned?pe((p(),q(T,{key:0,title:o._lang.common.actions,size:a(t).buttonSize.large,type:a(t).buttonType.secondary,disabled:a(c),class:fe(["d-sm-block d-none",{"dropdown-center":a(I)}])},{default:$(()=>[u(k,{title:o._lang.common.edit,onClick:ye(_,["prevent"]),disabled:a(c)},null,8,["title","onClick","disabled"])]),_:1},8,["title","size","type","disabled","class"])),[[O,w]]):v("",!0),a(F)?(p(),q(f,{key:1,class:"col-12 col-sm-auto d-sm-none",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:_,disabled:a(c)},null,8,["title","type","size","disabled"])):v("",!0)],64)):(p(),C(h,{key:0},[a(F)?(p(),q(f,{key:0,class:"col-12 col-sm-auto",title:o._lang.common.edit,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:_,disabled:a(c)},null,8,["title","type","size","disabled"])):v("",!0),a(X)?(p(),q(f,{key:1,class:"col-12 col-sm-auto",title:o._lang.common.extinctBtn,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:Y,disabled:a(c)},null,8,["title","type","size","disabled"])):v("",!0),a(F)?(p(),q(f,{key:2,class:"col-12 col-sm-auto",title:o._lang.common.createCopy,type:a(t).buttonType.secondary,size:a(t).buttonSize.large,onClick:Q,disabled:a(c)},null,8,["title","type","size","disabled"])):v("",!0)],64)),u(be,{id:j,startDate:e.formModel.startDate,endDate:e.formModel.endDate,service:e.service,itemId:e.itemId,itemVersion:e.itemVersion,backRoute:e.backRoute,itemIdField:e.itemIdField,ref_key:"extinctConfirmModalRef",ref:L},null,8,["startDate","endDate","service","itemId","itemVersion","backRoute","itemIdField"])],64)}}};export{Be as _};
